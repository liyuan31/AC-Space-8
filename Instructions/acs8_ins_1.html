<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instruction Page 1</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>

        body {
            background-color: black;
            overflow: hidden;
            min-height: 100vmin;
        }

        .ace_svg_container {
            display: inline-block;
            position: relative;
            width: 90vmin;
            height: 90vmin;
            padding-bottom: 100%;
            /* aspect ratio */
            vertical-align: top;
            overflow: hidden;
        }

        .ace_svg_content_responsive {
            display: inline-block;
            position: absolute;
            top: 0px;
            left: 0;
        }
    </style>
</head>

<body>

    <div id="workspace"></div>



    <script>
        const container = d3.select("#workspace").append("div")
            .attr("class", "ace_svg_container");
        const svg = container.append("svg")
            .attr("class", "ace_svg_content_responsive")
            .attr("viewBox", "0 0 100 100")
            .attr("preserveAspectRatio", "xMinYMin meet");

        class Square {
            constructor(x, y, w, h, fill, no, digit) {
                // actual parameter for a square
                this.x = x; // x coord
                this.y = y; // y coord
                this.w = w; // width
                this.h = h; // height
                this.fill = fill; // color
                // ACVS-specific things
                this.no = no; // square number, or, position
                this.digit = digit; // text on square
            }
        }

        // Generate data for d3 to use.
        // @para
        // radius = the radius of the ring
        // count = the number of squares on this ring
        // cx = x coord of ring center
        // cy = y coord of ring center
        // w = width (and height) of the square
        // colors = a list of strings representing color of each square
        // positions = a list of numbers representing the arbitrary position number of each square
        // digits = a list of numbers representing the digits on each square
        function generate_data_for_one_ring_of_squares(radius, count, cx, cy, w, colors, positions, digits) {

            let result = [];

            const alpha = 2 * Math.PI / count;

            for (let i = 0; i < count; i++) {

                currentColor = "";
                currentPosition = "";
                currentDigit = "";
                typeof colors === "string" ? currentColor = colors : currentColor = colors[i];
                typeof positions === "string" ? currentPosition = positions : currentPosition = positions[i];
                typeof digits === "string" ? currentDigit = digits : currentDigit = digits[i];

                let x = (Math.cos(alpha * i + Math.PI / 2) * radius + cx);
                let y = (Math.sin(alpha * i + Math.PI / 2) * radius + cy);

                result.push(new Square(x, y, w, w, currentColor, currentPosition, currentDigit));
            }
            return result;
        }


        const w = 3;    // width and height of squares
        const d = 60;  // diameter of the whole acvs stimuli display
        const r = (d - w) / 2;    // outer ring radius
        const cx = 70 - w / 2, cy = 30 - w / 2;
        const allColors = ["rgb(254, 0, 254)", "rgb(0, 150, 150)", "rgb(105, 105, 105)"];
        let colors = "212100110212110220222111121020001022100010220020211120";  // reproducible instruction display
        let digits = "978669996768697888887889969677693997967787586886767679";
        const get_a_list_of_colors = function (n) {
            let result = [];
            for (let i = 0; i < n; i++) {
                result.push(allColors[colors[colors.length - 1]]);
                colors = colors.slice(0, colors.length - 1);
            }
            return result;
        }
        const get_a_list_of_digits = function (n) {
            let result = [];
            for (let i = 0; i < n; i++) {
                result.push(digits[digits.length - 1]);
                digits = digits.slice(0, digits.length - 1);
            }
            return result;
        }
        // Helper function for generating a ring of <Square> objects
        // Given start and end index, return an array of strings representing positions
        const get_a_list_of_positions = function (startIndex, endIndex) {
            let result = [];
            for (let i = startIndex; i <= endIndex; i++) { result.push(`${i}`) }
            return result;
        }
        const data = generate_data_for_one_ring_of_squares(r, 24, cx, cy, w, get_a_list_of_colors(24), get_a_list_of_positions(0, 23), get_a_list_of_digits(24))
            .concat(generate_data_for_one_ring_of_squares(r * 0.75, 18, cx, cy, w, get_a_list_of_colors(18), get_a_list_of_positions(24, 41), get_a_list_of_digits(18))
                .concat(generate_data_for_one_ring_of_squares(r * 0.50, 12, cx, cy, w, get_a_list_of_colors(12), get_a_list_of_positions(42, 54), get_a_list_of_digits(12))));

        // Draw the rectangles on the screen:
        const acvs = svg.append("svg");
        const rects = acvs.selectAll("rect").data(data);
        rects.enter().append("rect")
            .attr("width", function (d) { return d.w })
            .attr("height", function (d) { return d.h })
            .attr("x", function (d) { return d.x })
            .attr("y", function (d) { return d.y })
            .attr("fill", function (d) { return d.fill })
            .attr("class", function (d) {
                // create a string representing class names
                let c = "";
                // add color names as a first class
                switch (d.fill) {
                    case "rgb(254, 0, 254)": c = "magenta"; break;
                    case "rgb(0, 150, 150)": c = "cyan"; break;
                    case "rgb(105, 105, 105)": c = "gray"
                }
                // add target/nontarget info as a second class
                switch (d.digit) {
                    case "2":
                    case "3":
                    case "4":
                    case "5":
                        c += " target"; break;
                    default: c += " nontarget"
                }
                return c;
            })
            .attr("id", function (d) { return `sq_${d.no}` });
        rects.exit().remove();

        // just add some flash effect on the two targets
        const targets = d3.selectAll(".target");
        const targetsFlashTrigger = function () {
            targets
                .transition()
                .duration(800)
                .attr("stroke", "white")
                .attr("stroke-width", ".4")
                .transition()
                .duration(800)
                .attr("stroke", null)
                .on("end", targetsFlashTrigger)
        }
        // targetsFlashTrigger();

        // Draw the text on the screen:
        let text_shift = 0.65;
        let text = acvs.selectAll("text").data(data);
        text.enter().append("text")
            .attr("x", (function (d) { return d.x + w / 3.25 + "" }))
            .attr("y", (function (d) { return d.y + w / 1.35 + "" }))
            .attr("fill", "white")
            .attr("class", "ace_pretty_text")
            .attr("font-size", w * text_shift + "")
            .text(function (d) { return d.digit });
        text.exit().remove();


        let paragraphs = ["In this experiment, you will be",
            "searching for a target square"];
        const texts = svg.append("svg");
        texts.selectAll("text").data(paragraphs)
            .enter().append("text")
                .text(d => d)
                    .attr("x", 2)
                    .attr("y", 2)
                    .attr("font-size", w)
                    .attr("fill", "white")
                    .each(d,i => { console.log(i) } );

    </script>
</body>

</html>